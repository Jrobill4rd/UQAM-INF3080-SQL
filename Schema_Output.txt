SQL> -- Script Oracle SQL*plus de creation du schema Micro-Info
SQL> -- Version sans accents
SQL> 
SQL> -- Creation des tables
SQL> CREATE TABLE Usager
  2  (noUsager		     NUMBER(19) 	     NOT NULL,
  3   motDePasse	     VARCHAR(25)	     NOT NULL,
  4   typeUsager     VARCHAR(15)
  5   CHECK(typeUsager IN('Client', 'Fournisseur', 'Commis')),
  6   PRIMARY KEY    (noUsager)
  7  )
  8  /

Table created.

SQL> CREATE TABLE Fournisseur
  2  (noUsager		     NUMBER(19) 	     NOT NULL,
  3   noFournisseur  NUMBER(19) 	     NOT NULL,
  4   telephone 	     CHAR(10)		     NOT NULL,
  5   raisonSociale  VARCHAR(50)	     NOT NULL,
  6   noCivique 	     NUMBER(19) 	     NOT NULL,
  7   rue		     VARCHAR(50)	     NOT NULL,
  8   ville		     VARCHAR(50)	     NOT NULL,
  9   pays		     VARCHAR(50)	     NOT NULL,
 10   codePostal	     VARCHAR(6) 	     NOT NULL,
 11   PRIMARY KEY    (noFournisseur),
 12   FOREIGN KEY    (noUsager) REFERENCES Usager
 13  )
 14  /

Table created.

SQL> CREATE TABLE Produit
  2  (noProduit 	     NUMBER(19) 	     NOT NULL,
  3   codeZebre 	     CHAR(12)		     NOT NULL,
  4   PRIMARY KEY    (noProduit)
  5  )
  6  /

Table created.

SQL> CREATE TABLE PrioriteFournisseur
  2  (noFournisseur  NUMBER(19) 	     NOT NULL,
  3   noProduit 	     NUMBER(19) 	     NOT NULL,
  4   priorite		     NUMBER(19) 	     NOT NULL,
  5   PRIMARY KEY    (noFournisseur),
  6   FOREIGN KEY    (noFournisseur) REFERENCES Fournisseur,
  7   FOREIGN KEY    (noProduit)	     REFERENCES Produit
  8  )
  9  /

Table created.

SQL> CREATE TABLE Client
  2  (noClient		     NUMBER(19) 	     NOT NULL,
  3   noUsager		     NUMBER(19) 	     NOT NULL,
  4   prenom		 VARCHAR(50)	     NOT NULL,
  5   nom		 VARCHAR(50)	     NOT NULL,
  6   telephone 	     CHAR(10)		     NOT NULL,
  7   qualite		 VARCHAR(25)	     NOT NULL,
  8   noCivique 	     NUMBER(19) 	     NOT NULL,
  9   rue		 VARCHAR(50)	     NOT NULL,
 10   ville		 VARCHAR(50)	     NOT NULL,
 11   pays		 VARCHAR(50)	     NOT NULL,
 12   codePostal	     CHAR(6)		     NOT NULL,
 13   PRIMARY KEY (noClient),
 14   FOREIGN KEY (noUsager) REFERENCES Usager
 15  )
 16  /

Table created.

SQL> CREATE TABLE TypeProduit
  2  (noProduit 		     NUMBER(19) 	     NOT NULL	     ,
  3   description	     VARCHAR(250)    NOT NULL,
  4   minimumEnStock	     NUMBER(19)      NOT NULL,
  5   quantiteEnStock	     NUMBER(19)      NOT NULL,
  6   PRIMARY KEY (noProduit),
  7   FOREIGN KEY (noProduit) REFERENCES Produit
  8  )
  9  /

Table created.

SQL> 
SQL> CREATE TABLE ProduitPrix
  2  (noProduit 		     NUMBER(19) 	     NOT NULL,
  3   dateEnVigueur	     DATE		 NOT NULL,
  4   prix			     NUMBER(19,4)    NOT NULL,
  5   PRIMARY KEY (noProduit),
  6   FOREIGN KEY (noProduit) REFERENCES Produit
  7  )
  8  /

Table created.

SQL> CREATE TABLE Commande
  2  (noCommande	     NUMBER(19) 	     NOT NULL,
  3   noClient		     NUMBER(19) 	     NOT NULL,
  4   dateCommande   DATE	     NOT NULL,
  5   typeStatusCommande VARCHAR(15)
  6   CHECK(typeStatusCommande IN ('Annulee','Livree','Payee','En Attente')),
  7   PRIMARY KEY (noCommande),
  8   FOREIGN KEY (noClient) REFERENCES Client
  9  )
 10  /

Table created.

SQL> CREATE TABLE LigneCommande
  2  (noCommande	     NUMBER(19) 	     NOT NULL,
  3   noProduit 	     NUMBER(19) 	     NOT NULL,
  4   quantite		     NUMBER(19) 	     NOT NULL,
  5   CHECK (quantite > 0),
  6   PRIMARY KEY (noCommande, noProduit),
  7   FOREIGN KEY (noCommande) REFERENCES Commande,
  8   FOREIGN KEY (noProduit)  REFERENCES Produit
  9  )
 10  /

Table created.

SQL> CREATE TABLE Livraison
  2  (noLivraison	     NUMBER(19) 	     NOT NULL,
  3   noClient			     NUMBER(19) 	     NOT NULL,
  4   dateLivraison	     DATE		     NOT NULL,
  5   PRIMARY KEY (noLivraison),
  6   FOREIGN KEY (noClient) REFERENCES Client
  7  )
  8  /

Table created.

SQL> CREATE TABLE LigneLivraison
  2  (noLivraison	     NUMBER(19) 	     NOT NULL,
  3   noProduit 		     NUMBER(19) 	     NOT NULL,
  4   noCommande		     NUMBER(19) 	     NOT NULL,
  5   quantiteLivree	 NUMBER(19)	 NOT NULL,
  6   PRIMARY KEY (noLivraison),
  7   FOREIGN KEY (noLivraison) REFERENCES Livraison,
  8   FOREIGN KEY (noProduit)	REFERENCES TypeProduit,
  9   FOREIGN KEY (noCommande)	REFERENCES Commande
 10  )
 11  /

Table created.

SQL> 
SQL> CREATE TABLE Facture
  2  (noLivraison	     NUMBER(19) 	     NOT NULL,
  3   montantSousTotal	     NUMBER(19,4)    NOT NULL,
  4   montantTaxes	     NUMBER(19,4)    NOT NULL,
  5   dateLimitePaiment  DATE		 NOT NULL,
  6   PRIMARY KEY (noLivraison),
  7   FOREIGN KEY (noLivraison) REFERENCES Livraison
  8   )
  9  /

Table created.

SQL> CREATE TABLE Paiement
  2  (noLivraison	     NUMBER(19) 	     NOT NULL,
  3   noPaiement	     NUMBER(19) 	     NOT NULL,
  4   datePaiement	     DATE		     NOT NULL,
  5   montant			     FLOAT(4)	     NOT NULL,
  6   PRIMARY KEY (noPaiement),
  7   FOREIGN KEY (noLivraison) REFERENCES Livraison
  8  )
  9  /

Table created.

SQL> CREATE TABLE PaiementCheque
  2  ( noPaiement	     NUMBER(19) 	     NOT NULL,
  3    noBanque 		 NUMBER(19)	     NOT NULL,
  4    noCompte 		 NUMBER(19)	     NOT NULL,
  5    PRIMARY KEY (noPaiement),
  6    FOREIGN KEY (noPaiement) REFERENCES Paiement(noPaiement)
  7  )
  8  /

Table created.

SQL> CREATE TABLE PaiementCarteCredit
  2  (noPaiement	     NUMBER(19)      NOT NULL,
  3   noCarte			     VARCHAR(25)     NOT NULL,
  4   typeCarteCredit	 VARCHAR(15)
  5   CHECK (typeCarteCredit IN('Visa','MasterCard','AmericanExpress')),
  6   dateExpiration	 DATE			     NOT NULL,
  7   PRIMARY KEY (noPaiement),
  8   FOREIGN KEY (noPaiement) REFERENCES Paiement(noPaiement)
  9   )
 10   /

Table created.

SQL>  -- Triggers
SQL> 
SQL> -- Réduire la quantité en stock d'un article en fonction de la quantité LIVRÉE
SQL> CREATE TRIGGER AjusterQteEnStock
  2  AFTER INSERT ON LigneLivraison
  3  REFERENCING
  4  	     NEW AS Achat
  5  FOR EACH ROW
  6  BEGIN
  7  	     UPDATE TypeProduit
  8  	     SET TypeProduit.quantiteEnStock = TypeProduit.quantiteEnStock - :Achat.quantiteLivree
  9  	     WHERE TypeProduit.noProduit = :Achat.noProduit;
 10  END;
 11  /

Trigger created.

SQL> -- Bloquer l'insertion d'une livraison d'un article lorsque la quantité livrée dépasse la quantité en stock
SQL> CREATE OR REPLACE TRIGGER bloquerInsertionStock
  2  BEFORE INSERT
  3  	     ON LigneLivraison
  4  REFERENCING
  5  	     NEW AS LivraisonStock
  6  FOR EACH ROW
  7  
  8  DECLARE quantiteStock INTEGER;
  9  
 10  BEGIN
 11  	     SELECT quantiteEnStock
 12  	     INTO quantiteStock
 13  	     FROM TypeProduit
 14  	     WHERE TypeProduit.noProduit = :LivraisonStock.noProduit;
 15  
 16  	     IF :LivraisonStock.quantiteLivree > quantiteStock THEN
 17  		     RAISE_APPLICATION_ERROR (-20100, 'La quantite livree ne peut depasser la quantite en stock');
 18  	     END IF;
 19  END;
 20  /

Trigger created.

SQL> -- Bloquer l'insertion d'une livraison d'un article  lorsque la quantité totale livrée dépasse la quantité commandée de la commande
SQL> CREATE OR REPLACE TRIGGER bloquerInsertionCommande
  2  BEFORE INSERT
  3  	     ON LigneLivraison
  4  REFERENCING
  5  	     NEW AS NouvelleLivraison
  6  FOR EACH ROW
  7  	     DECLARE
  8  		     qteLivree	     NUMBER(19);
  9  		     qteCommandee    NUMBER(19);
 10  BEGIN
 11  	     SELECT  SUM(quantiteLivree)
 12  	     INTO    qteLivree
 13  	     FROM    LigneLivraison
 14  	     WHERE   LigneLivraison.noProduit = :NouvelleLivraison.noProduit;
 15  
 16  	     SELECT  quantite
 17  	     INTO    qteCommandee
 18  	     FROM    LigneCommande
 19  	     WHERE   LigneCommande.noProduit = :NouvelleLivraison.noProduit;
 20  
 21  	     IF :NouvelleLivraison.quantiteLivree + qteLivree > qteCommandee THEN
 22  		     raise_application_error(-20100, 'La quantite a livrer est trop elevee');
 23  	     END IF;
 24  END;
 25  /

Trigger created.

SQL> --Bloquer l'insertion d'un paiement qui dépasse le montant qui reste à payer
SQL> CREATE OR REPLACE TRIGGER bloquerPaiement
  2  BEFORE INSERT
  3  	     ON Paiement
  4  REFERENCING
  5  	     NEW AS NouveauPaiement
  6  FOR EACH ROW
  7  	     DECLARE
  8  		     totalPaiement NUMBER(19,4);
  9  		     totalFacture  NUMBER(19,4);
 10  BEGIN
 11  	     SELECT  SUM(Facture.montantSousTotal + Facture.montantTaxes)
 12  	     INTO    totalFacture
 13  	     FROM    Facture
 14  	     WHERE   Facture.noLivraison = :NouveauPaiement.noLivraison;
 15  
 16  	     SELECT  SUM(montant)
 17  	     INTO    totalPaiement
 18  	     FROM    Paiement
 19  	     WHERE   Paiement.noLivraison = :NouveauPaiement.noLivraison;
 20  
 21  	     IF :NouveauPaiement.montant > (totalFacture - totalPaiement) THEN
 22  		     raise_application_error(-20300, 'Le montant a payer ne doit pas depasser le montant du');
 23  	     END IF;
 24  END;
 25  /

Trigger created.

SQL> @Fonctions_MicroInfo.sql
SQL> SET ECHO ON
SQL> -- Script Oracle SQL*plus de creation du schema Micro-Info
SQL> -- Version sans accents
SQL> 
SQL> -- Creation des fonctions
SQL> SET ECHO ON
SQL> 
SQL> CREATE OR REPLACE FUNCTION fQteDejaLivree
  2  (unNoProduit LigneLivraison.noProduit%TYPE, unNoCommande LigneLivraison.noCommande%TYPE)
  3  RETURN  LigneLivraison.quantiteLivree%TYPE IS
  4  
  5  	 quantiteDejalivree LigneLivraison.quantiteLivree%TYPE;
  6  BEGIN
  7  	SELECT	 SUM(quantiteLivree)
  8  	INTO	 quantiteDejalivree
  9  	FROM	 LigneLivraison
 10  	WHERE	 noProduit = unNoProduit AND noCommande = unNoCommande;
 11  	RETURN	 quantiteDejalivree;
 12  END fQteDejaLivree;
 13  /

Function created.

SQL> 
SQL> CREATE OR REPLACE FUNCTION fTotalFacture
  2  (unNoLivraison Facture.noLivraison%TYPE)
  3  RETURN Facture.montantSousTotal%TYPE IS
  4  
  5  	 MontTotalFacture Facture.montantSousTotal%TYPE;
  6  BEGIN
  7  	 SELECT  SUM(montantSousTotal + montantTaxes)
  8  	 INTO	 MontTotalFacture
  9  	 FROM	 Facture
 10  	 WHERE	 noLivraison = unNoLivraison;
 11  	 RETURN  MontTotalFacture;
 12  END fTotalFacture;
 13  /

Function created.

SQL> 
SQL> 
SQL> 
SQL> ---
SQL> ---
SQL> ---
SQL> ---
SQL> ---
SQL> ---
SQL> ---
SQL> CREATE OR REPLACE PROCEDURE p_PreparerLivraison
  2  	     (numCommande Commande.noCommande%TYPE, date_livraison Livraison.dateLivraison%TYPE) IS
  3  
  4  	     ---Déclaration de variables des informations client
  5  	     l_num_client Commande.noClient%TYPE;
  6  	     l_client Client%ROWTYPE;
  7  	     l_codepostal_client Client.codePostal%TYPE;
  8  	     --Déclaration de variables des informations pour chaque produit
  9  	     l_num_produit     TypeProduit.noProduit%TYPE; -- le numéro de produit
 10  	     l_desc_prod TypeProduit.description%TYPE; --la description du produit
 11  	     l_code_zebre Produit.codeZebre%TYPE; -- le code zebre du produit
 12  	     l_qte_a_livrer Commande.quantite%TYPE; --la quantité à livrer
 13  
 14  	     num_Livraison Livraison.noLivraison%TYPE; --le numéro de livraison de la commande
 15  
 16  	     --Déclaration d'un curseur sur les produits de la commande.
 17  	     CURSOR cur_produits_commandee IS
 18  		     SELECT noProduit
 19  		     FROM   LigneCommande
 20  		     WHERE  LigneCommande.noCommande = :numCommande;
 21  
 22  BEGIN
 23  	     DBMS_OUTPUT.PUT_LINE('Numéro de commande:' || numCommande)
 24  	     SELECT  noClient
 25  	     FROM    Commande
 26  	     INTO    l_num_client
 27  	     WHERE   Commande.noCommande = :numCommande;
 28  
 29  	     SELECT prenom,nom, telephone,qualite,noCivique, rue, ville, pays, codePostal
 30  	     FROM   Client
 31  	     INTO   l_client.prenom, l_client.nom, l_client.telephone, l_client.qualite,l_client.noCivique
 32  		     l_client.rue, l_client.ville, l_client.pays, l_client.codePostal
 33  	     WHERE   Client.noClient = l_num_client;
 34  	     DBMS_OUTPUT.PUT_LINE('NoClient:' || l_num_client);
 35  	     DBMS_OUTPUT.PUT_LINE('Prenom:' || l_client.prenom);
 36  	     DBMS_OUTPUT.PUT_LINE('Nom:' || l_client.nom);
 37  	     DBMS_OUTPUT.PUT_LINE('Telephone:' || l_client.telephone);
 38  	     DBMS_OUTPUT.PUT_LINE('Adresse:' || l_client.noCivique || ' ' || l_client.rue
 39  		     || ' ' || l_client.ville || ', ' || l_client.codePostal|| ', ' || l_client.pays);
 40  
 41  
 42  	     OPEN cur_produits_commandee;
 43  	     LOOP
 44  		     FETCH cur_produits_commandee INTO l_num_produit;
 45  		     EXIT WHEN cur_produits_commandee%NOTFOUND;
 46  
 47  		     SELECT codeZebre
 48  		     INTO    l_code_zebre
 49  		     FROM   Produit
 50  		     WHERE  Produit.noProduit = :l_num_produit;
 51  
 52  		     SELECT description
 53  		     INTO    l_desc_prod
 54  		     FROM    TypeProduit
 55  		     WHERE  Produit.noProduit = :l_num_produit;
 56  
 57  		     SELECT quantite
 58  		     INTO   l_qte_a_livrer;
 59  		     FROM    Commande
 60  		     WHERE  Produit.noProduit = :l_num_produit;
 61  
 62  		     DBMS_OUTPUT.PUT_LINE('NoProduit | CodeZebre | description | quantite');
 63  		     DBMS_OUTPUT.PUT_LINE('==============================================');
 64  		     DBMS_OUTPUT.PUT_LINE(l_num_produit || l_code_zebre || l_desc_prod || l_qte_a_livrer);
 65  
 66  	     END LOOP;
 67  	     CLOSE cur_produits_commandee;
 68  END;
 69  /

Warning: Procedure created with compilation errors.

SQL> exit
